<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì´ì•¼ê¸° ë§Œë“¤ê¸° - AI ë¶„ì„</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        
        .app-container { max-width: 700px; margin: 0 auto; padding: 40px 20px; }
        .app-container-wide { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .main-title { font-size: 32px; font-weight: 700; color: #06b6d4; margin-bottom: 12px; }
        .subtitle { font-size: 16px; color: #94a3b8; }
        
        .intro-box {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 40px;
        }
        
        .intro-text { color: #e2e8f0; font-size: 16px; line-height: 1.7; margin-bottom: 24px; }
        
        .btn-start {
            width: 100%;
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-start:hover { transform: translateY(-2px); }
        .btn-start:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-bar {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .progress-text { font-size: 14px; color: #94a3b8; margin-bottom: 12px; text-align: center; }
        .progress-track { background: rgba(71, 85, 105, 0.5); height: 8px; border-radius: 4px; }
        .progress-fill { background: linear-gradient(90deg, #06b6d4 0%, #0891b2 100%); height: 100%; transition: width 0.3s ease; }
        
        .event-form {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 30px;
        }
        
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #06b6d4; margin-bottom: 8px; }
        
        .form-input, .form-textarea {
            width: 100%;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 15px;
            color: #e2e8f0;
            font-family: inherit;
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }
        
        .form-textarea { resize: vertical; min-height: 100px; }
        
        .button-group { display: flex; gap: 12px; margin-top: 30px; }
        
        .btn {
            flex: 1;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }
        
        .btn-primary:hover { transform: translateY(-2px); }
        
        .btn-secondary {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #06b6d4;
        }
        
        .btn-secondary:hover { background: rgba(30, 41, 59, 0.8); }
        
        .analyzing-screen {
            text-align: center;
            padding: 60px 20px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(6, 182, 212, 0.2);
            border-top: 4px solid #06b6d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .analyzing-text { font-size: 18px; color: #e2e8f0; }
        
        .result-container {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px;
            padding: 32px;
        }
        
        .result-title { font-size: 24px; font-weight: 700; color: #06b6d4; margin-bottom: 30px; text-align: center; }
        
        /* Markdown Rendered Content Styles */
        .markdown-content {
            color: #e2e8f0;
            font-size: 15px;
            line-height: 1.8;
        }
        
        .markdown-content h2 {
            font-size: 20px;
            font-weight: 700;
            color: #06b6d4;
            margin: 32px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(6, 182, 212, 0.3);
        }
        
        .markdown-content h2:first-child {
            margin-top: 0;
        }
        
        .markdown-content h3 {
            font-size: 16px;
            font-weight: 600;
            color: #94a3b8;
            margin: 20px 0 12px 0;
        }
        
        .markdown-content p {
            margin-bottom: 12px;
        }
        
        .markdown-content strong {
            color: #fbbf24;
            font-weight: 600;
        }
        
        .markdown-content ul {
            margin: 12px 0;
            padding-left: 20px;
        }
        
        .markdown-content li {
            margin-bottom: 8px;
            color: #cbd5e1;
        }
        
        .markdown-content hr {
            border: none;
            border-top: 1px solid rgba(71, 85, 105, 0.5);
            margin: 24px 0;
        }
        
        .markdown-content code {
            background: rgba(6, 182, 212, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” ìŠ¤íƒ€ì¼ - ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 13px;
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .markdown-content th, .markdown-content td {
            border: 1px solid rgba(71, 85, 105, 0.5);
            padding: 8px 12px;
            text-align: left;
        }
        
        .markdown-content th {
            background: rgba(6, 182, 212, 0.2);
            color: #06b6d4;
            font-weight: 600;
        }
        
        .markdown-content td {
            background: rgba(15, 23, 42, 0.4);
        }
        
        @media (max-width: 768px) {
            .markdown-content table {
                font-size: 11px;
            }
            .markdown-content th, .markdown-content td {
                padding: 6px 8px;
            }
        }
        
        
        /* Journey Map Styles */
        .journey-timeline {
            position: relative;
            padding: 40px 0;
        }
        
        .journey-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            position: relative;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .journey-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .app-container-wide {
                max-width: 100%;
                padding: 20px 16px;
            }
            
            .main-title {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 14px;
            }
        }
        
        /* Tablet */
        @media (min-width: 769px) and (max-width: 1024px) {
            .journey-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .journey-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .journey-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid rgba(15, 23, 42, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
            position: relative;
            z-index: 2;
        }
        
        .journey-card {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 24px;
            min-height: 240px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .journey-card {
                min-height: auto;
            }
        }
        
        .journey-card:hover {
            transform: translateY(-8px);
        }
        
        .journey-period {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .journey-title {
            font-size: 16px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        .journey-section {
            margin-bottom: 12px;
        }
        
        .journey-label {
            font-size: 12px;
            color: #06b6d4;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .journey-text {
            font-size: 13px;
            color: #cbd5e1;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script type="text/babel">
        const { useState } = React;
        
        function MyStoryApp() {
            const [stage, setStage] = useState('intro');
            const [currentEvent, setCurrentEvent] = useState(1);
            const [userName, setUserName] = useState('');
            const [events, setEvents] = useState([
                { period: '', title: '', situation: '', action: '' },
                { period: '', title: '', situation: '', action: '' },
                { period: '', title: '', situation: '', action: '' },
                { period: '', title: '', situation: '', action: '' }
            ]);
            const [analysis, setAnalysis] = useState('');
            const [journeySkills, setJourneySkills] = useState([]);
            
            // ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜ (ì¤‘ë³µ ì œê±°)
            const resetApp = () => {
                setStage('intro');
                setCurrentEvent(1);
                setUserName('');
                setEvents([
                    { period: '', title: '', situation: '', action: '' },
                    { period: '', title: '', situation: '', action: '' },
                    { period: '', title: '', situation: '', action: '' },
                    { period: '', title: '', situation: '', action: '' }
                ]);
                setAnalysis('');
                setJourneySkills([]);
            };
            
            // ì €ë‹ˆë§µ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
            const downloadJourneyMap = async () => {
                const journeyElement = document.getElementById('journey-map-container');
                if (!journeyElement) {
                    alert('ì €ë‹ˆë§µì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                if (typeof html2canvas === 'undefined') {
                    alert('ì´ë¯¸ì§€ ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                try {
                    const canvas = await html2canvas(journeyElement, {
                        backgroundColor: '#0f172a',
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    // Blob ë°©ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ (ë” ì•ˆì •ì )
                    canvas.toBlob((blob) => {
                        if (!blob) {
                            alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                            return;
                        }
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = `${userName || 'ë‚˜'}_planned_happenstance_ì—¬ì •.png`;
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                } catch (error) {
                    console.error('Download error:', error);
                    alert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            
            const updateEvent = (field, value) => {
                const newEvents = [...events];
                newEvents[currentEvent - 1][field] = value;
                setEvents(newEvents);
            };
            
            const handleNext = () => {
                // ì…ë ¥ ê²€ì¦
                const current = events[currentEvent - 1];
                if (!current.period.trim() || !current.title.trim() || 
                    !current.situation.trim() || !current.action.trim()) {
                    alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (currentEvent < 4) {
                    setCurrentEvent(currentEvent + 1);
                } else {
                    analyzeEvents();
                }
            };
            
            const handlePrevious = () => {
                if (currentEvent > 1) {
                    setCurrentEvent(currentEvent - 1);
                }
            };
            
            const analyzeEvents = async () => {
                setStage('analyzing');
                
                // íƒ€ì„ì•„ì›ƒ ì„¤ì • (60ì´ˆ)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            events,
                            requestStructuredData: true  // êµ¬ì¡°í™”ëœ ë°ì´í„° ìš”ì²­
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    // ì‘ë‹µ ìƒíƒœ í™•ì¸
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server error:', response.status, errorText);
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${errorText.substring(0, 100)}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    if (!data.content || !data.content[0] || !data.content[0].text) {
                        console.error('Unexpected API response:', data);
                        throw new Error('API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                    
                    const responseText = data.content[0].text;
                    console.log('API Response:', responseText); // ë””ë²„ê¹…ìš©
                    
                    // JSON ë°ì´í„° ì¶”ì¶œ ì‹œë„
                    let displayText = responseText;
                    try {
                        // ì—¬ëŸ¬ íŒ¨í„´ìœ¼ë¡œ JSON ì°¾ê¸° ì‹œë„
                        let jsonMatch = responseText.match(/\{"events"\s*:\s*\[[\s\S]*?\]\}/);
                        if (!jsonMatch) {
                            jsonMatch = responseText.match(/```json\s*([\s\S]*?)```/);
                            if (jsonMatch) jsonMatch[0] = jsonMatch[1]; // ì½”ë“œë¸”ë¡ ë‚´ìš©ë§Œ ì¶”ì¶œ
                        }
                        if (!jsonMatch) {
                            jsonMatch = responseText.match(/\{[\s\S]*"events"[\s\S]*\}/);
                        }
                        
                        if (jsonMatch) {
                            console.log('JSON found:', jsonMatch[0]); // ë””ë²„ê¹…ìš©
                            const structuredData = JSON.parse(jsonMatch[0]);
                            setJourneySkills(structuredData.events || []);
                            // JSON ë¶€ë¶„ ë° ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡ ì „ì²´ ì œê±°
                            displayText = responseText
                                .replace(/#{1,3}\s*.*?JSON.*?\n/gi, '') // ## JSON í˜•ì‹ ê°™ì€ í—¤ë” ì œê±°
                                .replace(/```json[\s\S]*?```/gi, '')   // ```json ... ``` ë¸”ë¡ ì œê±°
                                .replace(/```[\s\S]*?```/gi, '')       // ê¸°íƒ€ ì½”ë“œë¸”ë¡ ì œê±°
                                .replace(jsonMatch[0], '')              // JSON ê°ì²´ ìì²´ ì œê±°
                                .replace(/\n{3,}/g, '\n\n')            // ì—°ì† ì¤„ë°”ê¿ˆ ì •ë¦¬
                                .trim();
                        } else {
                            console.log('JSON not found, extracting from text'); // ë””ë²„ê¹…ìš©
                            // JSONì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ê¸°ë³¸ ìŠ¤í‚¬ ì¶”ì¶œ
                            const extractedSkills = extractSkillsFromText(responseText);
                            setJourneySkills(extractedSkills);
                        }
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError); // ë””ë²„ê¹…ìš©
                        // íŒŒì‹± ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ì—ì„œ ìŠ¤í‚¬ ì¶”ì¶œ
                        const extractedSkills = extractSkillsFromText(responseText);
                        setJourneySkills(extractedSkills);
                    }
                    
                    setAnalysis(displayText);
                    setStage('result');
                } catch (error) {
                    if (error.name === 'AbortError') {
                        alert('ë¶„ì„ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    } else {
                        alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                    setStage('input');
                }
            };
            
            // í…ìŠ¤íŠ¸ì—ì„œ ìŠ¤í‚¬ ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
            const extractSkillsFromText = (text) => {
                const skillKeywords = ['Curiosity', 'Persistence', 'Flexibility', 'Optimism', 'Risk-taking'];
                const extracted = [];
                
                // ì—¬ëŸ¬ íŒ¨í„´ìœ¼ë¡œ ì´ë²¤íŠ¸ ì„¹ì…˜ ë¶„ë¦¬ ì‹œë„
                // ## ì´ë²¤íŠ¸ 1: ë˜ëŠ” ì´ë²¤íŠ¸ 1: ë˜ëŠ” **ì´ë²¤íŠ¸ 1** ë“±
                const eventSections = text.split(/##\s*ì´ë²¤íŠ¸\s*\d|ì´ë²¤íŠ¸\s*\d\s*:|Event\s*\d/i);
                
                console.log('Event sections found:', eventSections.length - 1); // ë””ë²„ê¹…
                
                eventSections.forEach((section, index) => {
                    if (index === 0) return; // ì²« ì„¹ì…˜ì€ í—¤ë”ì¼ ê°€ëŠ¥ì„±
                    
                    const foundSkills = [];
                    skillKeywords.forEach(skill => {
                        // ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê²€ìƒ‰
                        if (section.toLowerCase().includes(skill.toLowerCase())) {
                            foundSkills.push(skill);
                        }
                    });
                    
                    console.log(`Event ${index} skills:`, foundSkills); // ë””ë²„ê¹…
                    extracted.push({ skills: foundSkills });
                });
                
                // ì´ë²¤íŠ¸ ìˆ˜ë§Œí¼ ì±„ìš°ê¸°
                while (extracted.length < 4) {
                    extracted.push({ skills: [] });
                }
                
                return extracted.slice(0, 4);
            };
            
            const currentEventData = events[currentEvent - 1];
            const progress = (currentEvent / 4) * 100;
            
            // ìƒ‰ìƒ ë°°ì—´
            const eventColors = ['#06b6d4', '#0891b2', '#0e7490', '#155e75'];
            
            if (stage === 'intro') {
                return (
                    <div className="app-container">
                        <div className="header">
                            <h1 className="main-title">ë‚´ ì´ì•¼ê¸° ë§Œë“¤ê¸°</h1>
                            <p className="subtitle">ë‚˜ì˜ Planned Happenstance ì—¬ì •</p>
                        </div>
                        <div className="intro-box">
                            <p className="intro-text">
                                ì—¬ëŸ¬ë¶„ì˜ ì¸ìƒì—ì„œ <strong style={{color: '#06b6d4'}}>ìš°ì—°í•œ ì‚¬ê±´</strong>ì´ 
                                ì»¤ë¦¬ì–´ì— ì˜í–¥ì„ ì¤€ ìˆœê°„ì„ ë– ì˜¬ë ¤ë³´ì„¸ìš”.
                            </p>
                            <p className="intro-text">
                                4ê°€ì§€ ì£¼ìš” ì´ë²¤íŠ¸ë¥¼ ì…ë ¥í•˜ë©´, AIê°€ ìë™ìœ¼ë¡œ 
                                ì–´ë–¤ ê¸°ìˆ (Curiosity, Persistence, Flexibility, Optimism, Risk-taking)ì´ 
                                ë°œí˜„ë˜ì—ˆëŠ”ì§€ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.
                            </p>
                            <div style={{marginTop: '24px'}}>
                                <input 
                                    type="text" 
                                    className="form-input"
                                    placeholder="ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                                    value={userName}
                                    onChange={(e) => setUserName(e.target.value)}
                                    style={{marginBottom: '16px'}}
                                />
                            </div>
                            <button 
                                className="btn-start" 
                                onClick={() => setStage('input')}
                                disabled={!userName.trim()}
                            >
                                ì‹œì‘í•˜ê¸° â†’
                            </button>
                        </div>
                    </div>
                );
            }
            
            if (stage === 'input') {
                return (
                    <div className="app-container">
                        <div className="header">
                            <h1 className="main-title">ì´ë²¤íŠ¸ {currentEvent}/4</h1>
                        </div>
                        <div className="progress-bar">
                            <p className="progress-text">ì§„í–‰ë¥ : {Math.round(progress)}%</p>
                            <div className="progress-track">
                                <div className="progress-fill" style={{width: `${progress}%`}}></div>
                            </div>
                        </div>
                        <div className="event-form">
                            <div className="form-group">
                                <label className="form-label">ì‹œê¸°</label>
                                <input type="text" className="form-input" placeholder="ì˜ˆ: ëŒ€í•™êµ 2í•™ë…„, 2015ë…„ ì—¬ë¦„"
                                    value={currentEventData.period} onChange={(e) => updateEvent('period', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label className="form-label">ì´ë²¤íŠ¸ ì œëª©</label>
                                <input type="text" className="form-input" placeholder="ì˜ˆ: ìš°ì—°íˆ ì°¸ê°€í•œ ì°½ì—… ë™ì•„ë¦¬"
                                    value={currentEventData.title} onChange={(e) => updateEvent('title', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label className="form-label">ìš°ì—°í•œ ì‚¬ê±´</label>
                                <textarea className="form-textarea" placeholder="ì–´ë–¤ ìš°ì—°í•œ ì¼ì´ ì¼ì–´ë‚¬ë‚˜ìš”?"
                                    value={currentEventData.situation} onChange={(e) => updateEvent('situation', e.target.value)} />
                            </div>
                            <div className="form-group">
                                <label className="form-label">ë‚˜ì˜ í–‰ë™</label>
                                <textarea className="form-textarea" placeholder="ê·¸ ìƒí™©ì—ì„œ ì–´ë–»ê²Œ í–‰ë™í–ˆë‚˜ìš”?"
                                    value={currentEventData.action} onChange={(e) => updateEvent('action', e.target.value)} />
                            </div>
                            <div className="button-group">
                                {currentEvent > 1 && (
                                    <button className="btn btn-secondary" onClick={handlePrevious}>â† ì´ì „</button>
                                )}
                                <button className="btn btn-primary" onClick={handleNext}>
                                    {currentEvent < 4 ? 'ë‹¤ìŒ â†’' : 'AI ë¶„ì„ ì‹œì‘'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            if (stage === 'analyzing') {
                return (
                    <div className="app-container">
                        <div className="analyzing-screen">
                            <div className="spinner"></div>
                            <p className="analyzing-text">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>
                    </div>
                );
            }
            
            // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
            const renderMarkdown = (text) => {
                if (!text) return '';
                try {
                    return { __html: marked.parse(text) };
                } catch (e) {
                    return { __html: text };
                }
            };
            
            if (stage === 'result') {
                return (
                    <div className="app-container">
                        <div className="result-container">
                            <h2 className="result-title">{userName}ë‹˜ì˜ AI ë¶„ì„ ê²°ê³¼</h2>
                            
                            <div 
                                className="markdown-content" 
                                dangerouslySetInnerHTML={renderMarkdown(analysis)}
                            />
                            
                            <div className="button-group" style={{marginTop: '30px'}}>
                                <button className="btn btn-primary" onClick={() => setStage('journey_map')}>
                                    ì €ë‹ˆë§µ ë³´ê¸° ğŸ—ºï¸
                                </button>
                                <button className="btn btn-secondary" onClick={resetApp}>
                                    ë‹¤ì‹œ ë§Œë“¤ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            if (stage === 'journey_map') {
                return (
                    <div className="app-container-wide">
                        <div id="journey-map-container">
                            <div className="header">
                                <h1 className="main-title">{userName}ë‹˜ì˜ Planned Happenstance ì—¬ì •</h1>
                                <p className="subtitle">ìš°ì—°í•œ ì‚¬ê±´ë“¤ì´ ë§Œë“¤ì–´ë‚¸ ì»¤ë¦¬ì–´ ìŠ¤í† ë¦¬</p>
                            </div>
                            
                            <div className="journey-timeline">
                            <div className="journey-grid">
                                {events.map((event, index) => {
                                    const color = eventColors[index];
                                    
                                    return (
                                        <div key={index}>
                                            <div className="journey-point">
                                                <div 
                                                    className="journey-number"
                                                    style={{
                                                        background: color,
                                                        boxShadow: `0 0 20px ${color}40`
                                                    }}
                                                >
                                                    {index + 1}
                                                </div>
                                            </div>
                                            
                                            <div 
                                                className="journey-card"
                                                style={{
                                                    border: `2px solid ${color}40`
                                                }}
                                            >
                                                <div className="journey-period">{event.period}</div>
                                                <h3 className="journey-title">{event.title}</h3>
                                                
                                                <div className="journey-section">
                                                    <div className="journey-label">âš¡ ìš°ì—°í•œ ì‚¬ê±´</div>
                                                    <div className="journey-text">{event.situation}</div>
                                                </div>
                                                
                                                <div className="journey-section">
                                                    <div className="journey-label">ğŸ¬ ë‚˜ì˜ í–‰ë™</div>
                                                    <div className="journey-text">{event.action}</div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        </div>
                        
                        <div style={{textAlign: 'center', marginTop: '60px'}}>
                            <div className="button-group" style={{maxWidth: '600px', margin: '0 auto'}}>
                                <button className="btn btn-primary" onClick={downloadJourneyMap}>
                                    ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                                </button>
                                <button className="btn btn-secondary" onClick={() => setStage('result')}>
                                    â† ë¶„ì„ ê²°ê³¼
                                </button>
                                <button className="btn btn-secondary" onClick={resetApp}>
                                    ë‹¤ì‹œ ë§Œë“¤ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MyStoryApp />);
    </script>
</body>
</html>